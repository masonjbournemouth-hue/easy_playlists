// android/app/build.gradle  (Groovy, not KTS)
plugins {
    id 'com.android.application'
    id 'kotlin-android'
    id 'dev.flutter.flutter-gradle-plugin'
}

android {
    namespace "com.example.playlist_city"
    compileSdk flutter.compileSdkVersion
    ndkVersion "27.0.12077973"

    defaultConfig {
        applicationId "com.example.playlist_city"
        minSdk 21
        targetSdk flutter.targetSdkVersion
        versionCode flutter.versionCode
        versionName flutter.versionName

        multiDexEnabled true
    }

    signingConfigs {
        release {
            // Only configure if secrets are present (CI)
            if (System.getenv("KEYSTORE_PASSWORD") != null &&
                System.getenv("KEY_ALIAS") != null &&
                System.getenv("KEY_PASSWORD") != null) {
                storeFile file("release-keystore.jks")
                storePassword System.getenv("KEYSTORE_PASSWORD")
                keyAlias System.getenv("KEY_ALIAS")
                keyPassword System.getenv("KEY_PASSWORD")
            }
        }
    }

    buildTypes {
        release {
            // Use release signing if it’s configured; otherwise Gradle won’t crash
            if (signingConfigs.release.storeFile != null) {
                signingConfig signingConfigs.release
            }
            // Keep shrinkers off for now to reduce CI flakiness
            minifyEnabled false
            shrinkResources false

            // Keep native debug symbols so CI doesn’t try to strip them
            ndk {
                debugSymbolLevel 'FULL'
            }
        }
        debug {
            debuggable true
        }
    }

    // Toolchains
    compileOptions {
        sourceCompatibility JavaVersion.VERSION_11
        targetCompatibility JavaVersion.VERSION_11
    }
    kotlinOptions {
        jvmTarget = '11'
    }

    // Avoid META-INF clashes and keep .so symbols
    packagingOptions {
        jniLibs {
            keepDebugSymbols.add("**/*.so")
        }
        resources {
            excludes += ['META-INF/AL2.0', 'META-INF/LGPL2.1']
        }
    }
}

dependencies {
    implementation 'androidx.multidex:multidex:2.0.1'
}

