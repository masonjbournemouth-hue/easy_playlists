// android/app/build.gradle  (Groovy, not KTS)
plugins {
    id 'com.android.application'
    id 'kotlin-android'
    id 'dev.flutter.flutter-gradle-plugin'
}

// --- Read version info from pubspec.yaml (via local.properties) ---
def localProperties = new Properties()
def localPropertiesFile = rootProject.file('local.properties')
if (localPropertiesFile.exists()) {
    localPropertiesFile.withInputStream { stream -> localProperties.load(stream) }
}
def flutterVersionCode = localProperties.getProperty('flutter.versionCode')
if (flutterVersionCode == null) flutterVersionCode = '1'
def flutterVersionName = localProperties.getProperty('flutter.versionName')
if (flutterVersionName == null) flutterVersionName = '1.0'

android {
    namespace "com.playlistcity.app"
    compileSdk 35

    defaultConfig {
        applicationId "com.playlistcity.app"
        minSdk 21
        targetSdk flutter.targetSdkVersion

        // ✅ Automatically pulled from pubspec.yaml
        versionCode flutterVersionCode.toInteger()
        versionName flutterVersionName
    }

    signingConfigs {
        release {
            def keystoreProperties = new Properties()
            def keystoreFile = rootProject.file("android/key.properties")
            if (keystoreFile.exists()) {
                keystoreProperties.load(new FileInputStream(keystoreFile))
                storeFile file(keystoreProperties["storeFile"])
                storePassword keystoreProperties["storePassword"]
                keyAlias keystoreProperties["keyAlias"]
                keyPassword keystoreProperties["keyPassword"]
            } else {
                println("⚠️ Warning: android/key.properties not found, skipping local signing")
            }
        }
    }

    buildTypes {
        release {
            if (signingConfigs.release.storeFile != null) {
                signingConfig signingConfigs.release
            }

            // Disable shrinking/obfuscation for CI simplicity
            minifyEnabled false
            shrinkResources false

            // Keep native debug symbols (avoid “failed to strip”)
            ndk {
                debugSymbolLevel 'FULL'
            }

            // Skip symbol stripping (safe for Play uploads)
            packagingOptions {
                doNotStrip "**/*.so"
            }
        }

        debug {
            debuggable true
        }
    }

    // Toolchains
    compileOptions {
        sourceCompatibility JavaVersion.VERSION_11
        targetCompatibility JavaVersion.VERSION_11
    }
    kotlinOptions {
        jvmTarget = '11'
    }

    // Avoid META-INF clashes and keep .so symbols
    packagingOptions {
        jniLibs {
            keepDebugSymbols.add("**/*.so")
        }
        resources {
            excludes += ['META-INF/AL2.0', 'META-INF/LGPL2.1']
        }
    }
}

dependencies {
    implementation 'androidx.multidex:multidex:2.0.1'
}
